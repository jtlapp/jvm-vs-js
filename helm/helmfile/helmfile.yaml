environments:
  default:
    values:
      # provides the global values to templates in this helmfile
      - charts/global-values.yaml

---

helmDefaults:
  timeout: 30

releases:
  # backend database

  - name: backend-postgres
    chart: charts/backend-postgres
    values:
      - charts/global-values.yaml

  # client group

  - name: client
    chart: charts/client
    labels:
      clientGroup: "true"
    values:
      - charts/global-values.yaml
      - charts/values-secret.yaml

  - name: prometheus
    chart: prometheus-community/prometheus
    values:
      - charts/values-prometheus.yaml
    labels:
      clientGroup: "true"

  - name: grafana
    chart: grafana/grafana
    values:
      - charts/values-grafana.yaml
    labels:
      clientGroup: "true"
    hooks:
      - events: ["presync", "postuninstall"]
        command: "kubectl"
        args: [
          "delete",
          "configmap",
          "node-metrics-dashboard"
        ]
      - events: ["presync"]
        command: "kubectl"
        args: [
          "create",
          "configmap",
          "node-metrics-dashboard",
          "--from-file=charts/client/dashboards/node-metrics-dashboard.json"
        ]

  # application group

  - name: jooby-nomvc-app
    chart: charts/generic-app
    installed: {{ .Values | getOrNil "jooby-nomvc-app_installed" | default false }}
    labels:
      appGroup: "true"
    values:
      - charts/global-values.yaml
      - charts/values-secret.yaml
      - env:
        - name: SERVER_PORT
          value: "{{ .Values.global.app.port }}"
        - name: DATABASE_URL
          value: "jdbc:{{ .Values.global.pgbouncer.host }}"
        - name: DATABASE_USERNAME
          value: "{{ .Values.global.database.username }}"
        - name: DATABASE_PASSWORD
          value: "{{ .Values.global.database.password }}"

  - name: jooby-r2dbc-app
    chart: charts/generic-app
    installed: {{ .Values | getOrNil "jooby-r2dbc-app_installed" | default false }}
    labels:
      appGroup: "true"
    values:
      - charts/global-values.yaml
      - charts/values-secret.yaml
      - env:
        - name: SERVER_PORT
          value: "{{ .Values.global.app.port }}"
        - name: DATABASE_HOST_NAME
          value: "{{ .Values.global.pgbouncer.hostName }}"
        - name: DATABASE_PORT
          value: "{{ .Values.global.pgbouncer.port }}"
        - name: DATABASE_NAME
          value: "{{ .Values.global.database.name }}"
        - name: DATABASE_USERNAME
          value: "{{ .Values.global.database.username }}"
        - name: DATABASE_PASSWORD
          value: "{{ .Values.global.database.password }}"

  - name: jooby-vertx-app
    chart: charts/generic-app
    installed: {{ .Values | getOrNil "jooby-vertx-app_installed" | default false }}
    labels:
      appGroup: "true"
    values:
      - charts/global-values.yaml
      - charts/values-secret.yaml
      - env:
        - name: SERVER_PORT
          value: "{{ .Values.global.app.port }}"
        - name: DATABASE_HOST_NAME
          value: "{{ .Values.global.pgbouncer.hostName }}"
        - name: DATABASE_PORT
          value: "{{ .Values.global.pgbouncer.port }}"
        - name: DATABASE_NAME
          value: "{{ .Values.global.database.name }}"
        - name: DATABASE_USERNAME
          value: "{{ .Values.global.database.username }}"
        - name: DATABASE_PASSWORD
          value: "{{ .Values.global.database.password }}"

  - name: spring-async-app
    chart: charts/generic-app
    installed: {{ .Values | getOrNil "spring-async-app_installed" | default false }}
    labels:
      appGroup: "true"
    values:
      - charts/global-values.yaml
      - charts/values-secret.yaml

  - name: spring-jdbc-kernel-app
    chart: charts/spring-jdbc-app
    installed: {{ .Values | getOrNil "spring-jdbc-kernel-app_installed" | default false }}
    labels:
      appGroup: "true"
    values:
      - charts/global-values.yaml
      - charts/values-secret.yaml
      - spring:
          threads:
            virtual:
              enabled: "false"

  - name: spring-jdbc-virtual-app
    chart: charts/spring-jdbc-app
    installed: {{ .Values | getOrNil "spring-jdbc-virtual-app_installed" | default false }}
    labels:
      appGroup: "true"
    values:
      - charts/global-values.yaml
      - charts/values-secret.yaml
      - spring:
          threads:
            virtual:
              enabled: "true"

  - name: spring-webflux-app
    chart: charts/generic-app
    installed: {{ .Values | getOrNil "spring-webflux-app_installed" | default false }}
    labels:
      appGroup: "true"
    values:
      - charts/global-values.yaml
      - charts/values-secret.yaml
      - env:
        - name: SERVER_PORT
          value: "{{ .Values.global.app.port }}"
        - name: SPRING_R2DBC_URL
          value: "r2dbc:{{ .Values.global.pgbouncer.host }}"
        - name: SPRING_R2DBC_USERNAME
          value: "{{ .Values.global.database.username }}"
        - name: SPRING_R2DBC_PASSWORD
          value: "{{ .Values.global.database.password }}"
